#!/usr/bin/env bash

set -euo pipefail

# --- gum helpers ---
has_gum() { command -v gum >/dev/null 2>&1; }
log_info()  { if has_gum; then gum log --level info  "$@"; else echo "[INFO]  $*"; fi; }
log_warn()  { if has_gum; then gum log --level warn  "$@"; else echo "[WARN]  $*"; fi; }

confirm_or_force() {
  local prompt="$1"
  if [[ "$FORCE" == true ]]; then return 0; fi
  if has_gum && [[ -t 0 ]]; then gum confirm "$prompt"; return $?; fi
  return 1
}

spin() {
  local title="$1"; shift
  if has_gum && [[ -t 1 ]]; then
    gum spin --spinner dot --title "$title" -- "$@"
  else
    echo "$title"; "$@"
  fi
}

command_exists() {
  command -v "$1" >/dev/null 2>&1
}

FORCE=false
if [[ "${1:-}" == "--force" ]]; then
  FORCE=true
fi

log_info "Package cache cleanup"

if [[ "$FORCE" == false ]]; then
  if ! confirm_or_force "Purge all package caches?"; then
    log_info "Dry run â€” re-run with --force to execute"
  fi
fi

run_cmd() {
  local desc="$1"
  shift
  local cmd=("$@")

  log_info "$desc: ${cmd[*]}"

  if [[ "$FORCE" == true ]]; then
    spin "$desc" "${cmd[@]}" || log_warn "Command failed (continuing)"
  fi
}

# ------------------------
# Node Ecosystem
# ------------------------

if command_exists npm; then
  run_cmd "npm cache clean" npm cache clean --force
fi

if command_exists yarn; then
  run_cmd "yarn cache clean" yarn cache clean
fi

if command_exists pnpm; then
  run_cmd "pnpm store prune" pnpm store prune
fi

# ------------------------
# Python Ecosystem
# ------------------------

if command_exists pip; then
  run_cmd "pip cache purge" pip cache purge
fi

if command_exists pip3; then
  run_cmd "pip3 cache purge" pip3 cache purge
fi

if command_exists uv; then
  run_cmd "uv cache clean" uv cache clean
fi

if command_exists poetry; then
  run_cmd "poetry cache clear" poetry cache clear --all pypi
fi

# ------------------------
# Terraform
# ------------------------

if command_exists terraform; then
  run_cmd "Terraform plugin cache (manual removal)" \
    bash -c 'rm -rf "${TF_PLUGIN_CACHE_DIR:-$HOME/.terraform.d/plugin-cache}"'
fi

# ------------------------
# Go
# ------------------------

if command_exists go; then
  run_cmd "Go module cache clean" go clean -modcache
fi

# ------------------------
# Cargo
# ------------------------

if command_exists cargo; then
  run_cmd "cargo cache clean" cargo cache --autoclean
fi

if [[ "$FORCE" == true ]]; then
  log_info "Cleanup complete."
else
  log_info "Dry run complete. Re-run with --force to delete."
fi
