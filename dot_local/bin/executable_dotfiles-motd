#!/bin/sh
# Print a brief brew-groups status on new interactive shells.
# Sourced by .bashrc and .zshrc — only prints when some groups are
# disabled. Skips in Claude Code sessions.

[ -n "$CLAUDECODE" ] && return 0 2>/dev/null

BREWFILE="$HOME/.Brewfile"
CONFIG="$HOME/.config/brew-groups"

[ -f "$BREWFILE" ] || return 0 2>/dev/null

# Discover all groups from Brewfile
all_groups=""
group_count=0
while IFS= read -r line; do
  line="${line%$(printf '\r')}"
  case "$line" in
    "# === "*)
      name="${line#\# === }"
      name="${name%%:*}"
      all_groups="$all_groups|$name|"
      group_count=$((group_count + 1))
      ;;
  esac
done < "$BREWFILE"

[ "$group_count" -eq 0 ] && return 0 2>/dev/null

# Read enabled groups into a searchable string
enabled="|"
enabled_count=0
if [ -f "$CONFIG" ]; then
  while IFS= read -r line; do
    line="${line%$(printf '\r')}"
    line="$(echo "$line" | tr -d ' ')"
    if [ -n "$line" ]; then
      enabled="${enabled}${line}|"
      enabled_count=$((enabled_count + 1))
    fi
  done < "$CONFIG"
fi
# core is always implicitly enabled
case "$enabled" in
  *"|core|"*) ;;
  *) enabled="${enabled}core|"; enabled_count=$((enabled_count + 1)) ;;
esac

[ "$enabled_count" -ge "$group_count" ] && return 0 2>/dev/null

disabled_count=$((group_count - enabled_count))
printf 'brew: %d of %d package groups enabled · run "brew-groups" to add more\n' \
  "$enabled_count" "$group_count"
