#!/bin/sh
# Print environment summary and brew-groups status on new interactive shells.
# Sourced by .bashrc and .zshrc. Skips in Claude Code sessions.

[ -n "$CLAUDECODE" ] && return 0 2>/dev/null

# --- Colors ---
_c_reset=$(printf '\033[0m')
_c_bold=$(printf '\033[1m')
_c_dim=$(printf '\033[2m')
_c_green=$(printf '\033[32m')
_c_cyan=$(printf '\033[36m')

# --- System info ---
_motd_host="$(hostname -s 2>/dev/null || hostname)"

if [ -n "$ZSH_VERSION" ]; then
  _motd_shell="zsh $ZSH_VERSION"
elif [ -n "$BASH_VERSION" ]; then
  _motd_shell="bash $BASH_VERSION"
else
  _motd_shell="sh"
fi

# External IP (2s timeout, fail silently)
_motd_ip="$(curl -sf --max-time 2 https://api.ipify.org 2>/dev/null \
  || curl -sf --max-time 2 https://icanhazip.com 2>/dev/null \
  || true)"
_motd_ip="$(echo "$_motd_ip" | tr -d '[:space:]')"

# --- Brew groups ---
_motd_brewfile="$HOME/.Brewfile"
_motd_config="$HOME/.config/brew-groups"
_motd_group_count=0
_motd_has_disabled=false

_motd_all_names=""
_motd_enabled="|"
_motd_group_lines=""

if [ -f "$_motd_brewfile" ]; then
  # Discover all groups
  while IFS= read -r _motd_line; do
    _motd_line="${_motd_line%$(printf '\r')}"
    case "$_motd_line" in
      "# === "*)
        _motd_name="${_motd_line#\# === }"
        _motd_name="${_motd_name%%:*}"
        _motd_all_names="$_motd_all_names $_motd_name"
        _motd_group_count=$((_motd_group_count + 1))
        ;;
    esac
  done < "$_motd_brewfile"

  # Read enabled groups
  if [ -f "$_motd_config" ]; then
    while IFS= read -r _motd_line; do
      _motd_line="${_motd_line%$(printf '\r')}"
      _motd_line="$(echo "$_motd_line" | tr -d ' ')"
      [ -n "$_motd_line" ] && _motd_enabled="${_motd_enabled}${_motd_line}|"
    done < "$_motd_config"
  fi
  case "$_motd_enabled" in
    *"|core|"*) ;;
    *) _motd_enabled="${_motd_enabled}core|" ;;
  esac

  # Build group display lines (3 per row)
  _motd_row=""
  _motd_col=0
  for _motd_g in $_motd_all_names; do
    case "$_motd_enabled" in
      *"|$_motd_g|"*)
        _motd_row="$_motd_row  ${_c_green}●${_c_reset} $_motd_g"
        ;;
      *)
        _motd_row="$_motd_row  ${_c_dim}○ $_motd_g${_c_reset}"
        _motd_has_disabled=true
        ;;
    esac
    _motd_col=$((_motd_col + 1))
    if [ "$_motd_col" -eq 3 ]; then
      _motd_group_lines="$_motd_group_lines$_motd_row
"
      _motd_row=""
      _motd_col=0
    fi
  done
  [ -n "$_motd_row" ] && _motd_group_lines="$_motd_group_lines$_motd_row"
fi

# --- Render ---
if command -v gum >/dev/null 2>&1 && [ -t 1 ]; then
  _motd_subtitle="${DOTFILES_ENV:-unknown} · ${_motd_shell}"
  [ -n "$_motd_ip" ] && _motd_subtitle="$_motd_subtitle · $_motd_ip"

  _motd_body="${_c_bold}${_c_cyan}  ${_motd_host}${_c_reset}
  ${_c_dim}${_motd_subtitle}${_c_reset}"

  if [ "$_motd_group_count" -gt 0 ]; then
    _motd_body="$_motd_body

$_motd_group_lines"
  fi

  echo ""
  printf '%s\n' "$_motd_body" | gum style \
    --border rounded \
    --border-foreground 62 \
    --padding "0 1" \
    --no-strip-ansi

  if [ "$_motd_has_disabled" = true ]; then
    gum style --faint --italic '  run "brew-groups" to enable more packages'
  fi
  echo ""
else
  # Plain text fallback
  echo ""
  _motd_plain="${_motd_host} | ${DOTFILES_ENV:-unknown} | $_motd_shell"
  [ -n "$_motd_ip" ] && _motd_plain="$_motd_plain | $_motd_ip"
  echo "$_motd_plain"
  if [ "$_motd_group_count" -gt 0 ]; then
    echo ""
    for _motd_g in $_motd_all_names; do
      case "$_motd_enabled" in
        *"|$_motd_g|"*) printf '  [x] %s\n' "$_motd_g" ;;
        *)              printf '  [ ] %s\n' "$_motd_g" ;;
      esac
    done
    if [ "$_motd_has_disabled" = true ]; then
      echo ""
      echo "  run \"brew-groups\" to enable more packages"
    fi
  fi
  echo ""
fi

# Cleanup (sourced script, don't pollute shell)
unset _c_reset _c_bold _c_dim _c_green _c_cyan
unset _motd_host _motd_shell _motd_ip _motd_subtitle _motd_plain
unset _motd_brewfile _motd_config _motd_line _motd_name _motd_g
unset _motd_all_names _motd_enabled _motd_group_lines _motd_row _motd_col
unset _motd_group_count _motd_has_disabled _motd_body
