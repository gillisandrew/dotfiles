#!/usr/bin/env bash

set -eo pipefail

# --- helpers ---
has_gum() { command -v gum >/dev/null 2>&1; }
log_info()  { if has_gum; then gum log --level info  "$@"; else echo "[INFO]  $*"; fi; }
log_warn()  { if has_gum; then gum log --level warn  "$@"; else echo "[WARN]  $*"; fi; }
log_error() { if has_gum; then gum log --level error "$@"; else echo "[ERROR] $*"; fi; }

BREWFILE_DIR="$HOME/.Brewfile.d"

if [[ ! -d "$BREWFILE_DIR" ]]; then
  log_error "No Brewfile directory found at $BREWFILE_DIR"
  exit 1
fi

# --- Discover available roles ---
ROLES=()
for f in "$BREWFILE_DIR"/*; do
  [[ -f "$f" ]] && ROLES+=("$(basename "$f")")
done

if [[ ${#ROLES[@]} -eq 0 ]]; then
  log_warn "No role files found in $BREWFILE_DIR"
  exit 1
fi

# --- Parse arguments ---
SELECTED=()
if [[ $# -gt 0 ]]; then
  if [[ "$1" == "--all" ]]; then
    SELECTED=("${ROLES[@]}")
  else
    SELECTED=("$@")
  fi
else
  # --- Check which roles are already satisfied ---
  log_info "Checking installed roles..."
  SATISFIED=()
  for role in "${ROLES[@]}"; do
    if brew bundle check --file="$BREWFILE_DIR/$role" >/dev/null 2>&1; then
      SATISFIED+=("$role")
    fi
  done

  # --- Interactive selection ---
  if has_gum && [[ -t 0 ]]; then
    GUM_ARGS=(--no-limit)
    if [[ ${#SATISFIED[@]} -gt 0 ]]; then
      SELECTED_CSV=$(IFS=,; echo "${SATISFIED[*]}")
      GUM_ARGS+=("--selected=$SELECTED_CSV")
    fi

    log_info "Select roles to install:"
    CHOSEN=()
    while IFS= read -r line; do
      [[ -n "$line" ]] && CHOSEN+=("$line")
    done < <(gum choose "${GUM_ARGS[@]}" "${ROLES[@]}")

    if [[ ${#CHOSEN[@]} -eq 0 ]]; then
      log_warn "No roles selected"
      exit 0
    fi
    SELECTED=("${CHOSEN[@]}")
  else
    # Plain text fallback
    echo "Available roles (* = installed):"
    echo ""
    for i in "${!ROLES[@]}"; do
      marker=" "
      for s in "${SATISFIED[@]}"; do
        [[ "$s" == "${ROLES[$i]}" ]] && marker="*" && break
      done
      echo "  $((i + 1))) [$marker] ${ROLES[$i]}"
    done
    echo ""
    echo "Enter role names or numbers separated by spaces (or 'all'):"
    read -r INPUT
    if [[ "$INPUT" == "all" ]]; then
      SELECTED=("${ROLES[@]}")
    else
      for token in $INPUT; do
        if [[ "$token" =~ ^[0-9]+$ ]] && (( token >= 1 && token <= ${#ROLES[@]} )); then
          SELECTED+=("${ROLES[$((token - 1))]}")
        else
          SELECTED+=("$token")
        fi
      done
    fi
  fi
fi

# --- Validate selected roles ---
for role in "${SELECTED[@]}"; do
  if [[ ! -f "$BREWFILE_DIR/$role" ]]; then
    log_error "Unknown role: $role"
    exit 1
  fi
done

# --- Install: core first if selected, then rest ---
ORDERED=()
for role in "${SELECTED[@]}"; do
  [[ "$role" == "core" ]] && ORDERED=("core" "${ORDERED[@]}")
  [[ "$role" != "core" ]] && ORDERED+=("$role")
done

for role in "${ORDERED[@]}"; do
  log_info "Installing role: $role"
  brew bundle --file="$BREWFILE_DIR/$role"
done

log_info "Done"
