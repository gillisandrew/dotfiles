#!/usr/bin/env bash
# get-ses-prod-access-status - Check SES production access across all AWS profiles and regions
# Usage: get-ses-prod-access-status
# Requires: aws cli, active SSO session (run refresh-zorg-profiles first)

set -euo pipefail

REGIONS=("us-east-1" "ca-central-1")

# Collect all profile names from ~/.aws/config
PROFILES=$(awk '/^\[profile / {print $2}' ~/.aws/config | tr -d ']')

# Print table header
printf "%-20s %-15s" "PROFILE" "ACCOUNT"
for r in "${REGIONS[@]}"; do
    printf " %-20s" "$r"
done
printf "\n"

# Loop through profiles
for profile in $PROFILES; do
    account_id=$(aws sts get-caller-identity --query "Account" --output text --profile "$profile" 2>/dev/null || echo "ERROR")

    printf "%-20s %-15s" "$profile" "$account_id"

    for region in "${REGIONS[@]}"; do
        status=$(aws sesv2 get-account \
            --region "$region" \
            --profile "$profile" \
            --query "ProductionAccessEnabled" \
            --output text 2>/dev/null || echo "N/A")

        printf " %-20s" "$status"
    done

    printf "\n"
done
