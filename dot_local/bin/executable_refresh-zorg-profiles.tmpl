#!/usr/bin/env zsh
#
# refresh-zorg-profiles - Regenerate AWS SSO profiles from Identity Center
# Logs into SSO, enumerates accounts, and writes ~/.aws/config.
#
# Usage: refresh-zorg-profiles

unset AWS_PROFILE

set -euo pipefail

# Values baked in by chezmoi from .chezmoi.toml
AWS_SSO_SESSION="{{ .aws.sso_session }}"
AWS_SSO_ROLE_NAME="{{ .aws.sso_role_name }}"
AWS_SSO_REGION="{{ .aws.sso_region }}"
AWS_SSO_START_URL="{{ .aws.sso_start_url }}"
AWS_CONFIG_FILE="$HOME/.aws/config"
CURRENT_DATE=$(date +%Y%m%d%H%M%S)

create_temp_config() {
  local temp_config
  temp_config=$(mktemp)
  cat > "$temp_config" <<EOF
[default]
cli_pager=

; This file is auto-generated by refresh-zorg-profiles ($CURRENT_DATE)
[sso-session $AWS_SSO_SESSION]
sso_region = $AWS_SSO_REGION
sso_start_url = $AWS_SSO_START_URL
EOF
  echo "$temp_config"
}

sso_login() {
  local config_file="$1"
  AWS_CONFIG_FILE="$config_file" aws sso login --sso-session "$AWS_SSO_SESSION"
}

get_access_token() {
  jq -r '.accessToken' $(ls -t ~/.aws/sso/cache/*.json | head -n 1)
}

add_profiles_to_config() {
  local config_file="$1"
  local access_token="$2"
  local accounts
  accounts=($(aws sso list-accounts --access-token "$access_token" --region "$AWS_SSO_REGION" --output json | jq -r '.accountList[] | "\(.accountName):\(.accountId)"'))
  for entry in $accounts; do
    local account_name="${entry%%:*}"
    local account_id="${entry##*:}"
    account_name="${account_name// /-}"
    printf "\n[profile %s]\nsso_session = %s\nsso_account_id = %s\nsso_role_name = %s\nregion = %s\noutput = json\n" \
      "$account_name" "$AWS_SSO_SESSION" "$account_id" "$AWS_SSO_ROLE_NAME" "$AWS_SSO_REGION" >> "$config_file"
  done

  # Output enabled accounts to stdout
  echo ""
  echo "Account ID   | Account Name"
  echo "============ | ============================="
  for entry in $accounts; do
    local account_name="${entry%%:*}"
    local account_id="${entry##*:}"
    echo "$account_id | $account_name"
  done
  echo ""
}

main() {
  local temp_config access_token
  temp_config=$(create_temp_config)
  sso_login "$temp_config"
  access_token=$(get_access_token)
  add_profiles_to_config "$temp_config" "$access_token"
  # Move existing config to a backup file (with timestamp)
  if [[ -f "$AWS_CONFIG_FILE" ]]; then
    mv "$AWS_CONFIG_FILE" "$AWS_CONFIG_FILE.$CURRENT_DATE.bak"
  fi
  cp "$temp_config" "$AWS_CONFIG_FILE"
  rm "$temp_config"
  echo "AWS SSO profiles updated for all enabled accounts."
}

main "$@"