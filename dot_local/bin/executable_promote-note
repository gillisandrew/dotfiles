#!/bin/bash

# promote-note - Promote a draft note to the notes directory with path updates
# Usage: promote-note [--force] "note title"
# Must be run from the root of a notes repository

# --- gum helpers ---
has_gum() { command -v gum >/dev/null 2>&1; }
log_info()  { if has_gum; then gum log --level info  "$@"; else echo "[INFO]  $*"; fi; }
log_warn()  { if has_gum; then gum log --level warn  "$@"; else echo "[WARN]  $*"; fi; }
log_error() { if has_gum; then gum log --level error "$@"; else echo "[ERROR] $*"; fi; }

confirm_action() {
  local prompt="$1"
  if has_gum && [[ -t 0 ]]; then gum confirm "$prompt"; return $?; fi
  return 0
}

spin() {
  local title="$1"; shift
  if has_gum && [[ -t 1 ]]; then
    gum spin --spinner dot --title "$title" -- "$@"
  else
    "$@"
  fi
}

promote_note() {
    local force=false
    if [[ "${1:-}" == "--force" ]]; then
        force=true
        shift
    fi

    local note_name="$1"

    if [[ -z "$note_name" ]]; then
        log_error "Usage: promote-note [--force] 'note title'"
        echo "Example: promote-note 'VPC Lattice proxy patterns'"
        echo ""
        echo "Must be run from the root of a notes repository containing drafts/ and notes/ directories"
        return 1
    fi

    # Verify we're in the right directory structure
    if [[ ! -d "drafts" ]] || [[ ! -d "notes" ]]; then
        log_error "Must be run from a directory containing 'drafts/' and 'notes/' subdirectories"
        echo "Current directory: $(pwd)"
        return 1
    fi

    local draft_file="drafts/${note_name}.md"
    local notes_file="notes/${note_name}.md"

    # Check if draft file exists
    if [[ ! -f "$draft_file" ]]; then
        log_error "Draft file '$draft_file' not found"
        return 1
    fi

    # Check if notes file already exists
    if [[ -f "$notes_file" ]]; then
        log_error "File '$notes_file' already exists in notes directory"
        return 1
    fi

    log_info "Promoting note: $note_name"
    log_info "From: $draft_file"
    log_info "To: $notes_file"

    if [[ "$force" == false ]]; then
        if ! confirm_action "Promote '$note_name' from drafts to notes?"; then
            log_warn "Aborted"
            return 1
        fi
    fi

    # Copy the file to notes directory
    if ! spin "Copying to notes..." cp "$draft_file" "$notes_file"; then
        log_error "Failed to copy file to notes directory"
        return 1
    fi

    # URL-encode the note name for path matching (spaces become %20)
    local encoded_name="${note_name// /%20}"

    log_info "Searching for references to update..."

    local updated_count=0

    # Find files in drafts that reference this note with ./
    if grep -r -l --include="*.md" "\\./${note_name}\\.md\\|\\./${encoded_name}\\.md\\|\\[.*\\]: \\./${encoded_name}\\.md" drafts/ 2>/dev/null; then
        log_info "Found references in drafts directory, updating..."
        grep -r -l --include="*.md" "\\./${note_name}\\.md\\|\\./${encoded_name}\\.md\\|\\[.*\\]: \\./${encoded_name}\\.md" drafts/ 2>/dev/null | \
        while read -r file; do
            log_info "  Updating: $file"
            # Update inline links from ./ to ../notes/
            sed -i '' "s|\\./${note_name}\\.md|../notes/${note_name}.md|g" "$file"
            sed -i '' "s|\\./${encoded_name}\\.md|../notes/${encoded_name}.md|g" "$file"
            # Update reference-style link definitions
            sed -i '' "s|\\[\\([^]]*\\)\\]: \\./${encoded_name}\\.md|[\\1]: ../notes/${encoded_name}.md|g" "$file"
            ((updated_count++))
        done
    fi

    # Search in notes directory for references (these should already be correct but check)
    if grep -r -l --include="*.md" "\\./${note_name}\\.md\\|\\./${encoded_name}\\.md" notes/ 2>/dev/null; then
        log_info "Found references in notes directory (should be correct):"
        grep -r -l --include="*.md" "\\./${note_name}\\.md\\|\\./${encoded_name}\\.md" notes/ 2>/dev/null | \
        while read -r file; do
            log_info "  Reference already correct in: $file"
        done
    fi

    # Search in reports directory for references
    if [[ -d "reports" ]]; then
        if grep -r -l --include="*.md" "\\.\\./notes/${note_name}\\.md\\|\\.\\./notes/${encoded_name}\\.md" reports/ 2>/dev/null; then
            log_info "Found references in reports directory (should be correct):"
            grep -r -l --include="*.md" "\\.\\./notes/${note_name}\\.md\\|\\.\\./notes/${encoded_name}\\.md" reports/ 2>/dev/null | \
            while read -r file; do
                log_info "  Reference already correct in: $file"
            done
        fi
    fi

    # Remove the original draft file
    log_info "Removing original draft file..."
    if spin "Removing draft..." rm "$draft_file"; then
        log_info "Successfully promoted '$note_name' from drafts to notes"
    else
        log_warn "Failed to remove original draft file '$draft_file'"
        log_warn "Note was copied successfully but manual cleanup needed"
        return 1
    fi

    # Summary
    echo ""
    log_info "Promotion complete!"
    log_info "- Note moved from drafts/ to notes/"
    if [[ $updated_count -gt 0 ]]; then
        log_info "- Updated $updated_count files with path references"
    else
        log_info "- No path references needed updating"
    fi
    log_info "- Original draft file removed"

    # Verify the new file exists
    if [[ -f "$notes_file" ]]; then
        log_info "- New file verified at: $notes_file"
    else
        log_warn "- Could not verify new file at: $notes_file"
    fi
}

# If called directly (not sourced), execute the function with all arguments
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    promote_note "$@"
fi
