## .zshrc: interactive shell config
# Runs for interactive shells only.
# Good: prompt/theme, aliases, functions, completions, keybindings.
# Avoid: PATH/toolchain exports (keep those in .zprofile).

[[ -o interactive ]] || return

. "$HOME/.local/bin/dotfiles-env"

autoload -Uz compinit && compinit

if [ "$DOTFILES_ENV" = "macos" ]; then
  export SSH_AUTH_SOCK="$HOME/.bitwarden-ssh-agent.sock"
fi

# Common aliases
if [ "$DOTFILES_ENV" = "macos" ]; then
  alias espansoconfig="code \"$HOME/.config/espanso\""
fi
[ "$(command -v curlie)" ] && alias curl="curlie"
[ "$(command -v bat)" ] && alias cat="bat"

extract () {
  if [ -f "$1" ] ; then
    case $1 in
      *.tar.bz2)   tar xjf $1     ;;
      *.tar.gz)    tar xzf $1     ;;
      *.bz2)       bunzip2 $1     ;;
      *.rar)       unrar e $1     ;;
      *.gz)        gunzip $1      ;;
      *.tar)       tar xf $1      ;;
      *.tbz2)      tar xjf $1     ;;
      *.tgz)       tar xzf $1     ;;
      *.zip)       unzip $1       ;;
      *.Z)         uncompress $1  ;;
      *.7z)        7z x $1        ;;
      *)     echo "'$1' cannot be extracted via extract()" ;;
        esac
    else
      echo "'$1' is not a valid file"
    fi
}

refresh_github_token() {
  if ! command -v gh >/dev/null 2>&1; then
    echo "GitHub CLI (gh) is not installed."
    return 1
  fi

  if ! gh auth status >/dev/null 2>&1; then
    echo "No active GitHub CLI authentication session found."
    return 2
  fi

  local env_file="$HOME/.local/env/$1"
  if [ ! -f "$env_file" ]; then
    echo "Environment file '$env_file' not found."
    return 3
  fi

  local new_token
  new_token=$(gh auth token 2>/dev/null)
  if [ -z "$new_token" ]; then
    echo "Failed to retrieve GitHub token."
    return 4
  fi

  local var_name="${2:-GITHUB_TOKEN}"
  sed -i.bak -E "s|^(${var_name}=).*|\1$new_token|" "$env_file"
  echo "$var_name updated in $env_file"

}

export CARAPACE_BRIDGES='zsh,fish,bash,inshellisense' # optional
export CARAPACE_MATCH=1
# zstyle ':completion:*' format $'\e[2;37mCompleting %d\e[m'

if [ -z "$CLAUDECODE" ]; then
  [ -z "$DISABLE_CARAPACE" ] && [ "$(command -v carapace)" ] && source <(carapace _carapace zsh)
  # [ -z "$DISABLE_FZF" ] && [ "$(command -v fzf)" ] && source <(fzf --zsh)
  # [ -z "$DISABLE_TV" ] && [ "$(command -v tv)" ] && eval "$(tv init zsh)"
  [ -z "$DISABLE_STARSHIP" ] && [ "$(command -v starship)" ] && eval "$(starship init zsh)"
  # [ -z "$DISABLE_MCFLY" ] && [ "$(command -v mcfly)" ] && eval "$(mcfly init zsh)"
  [ -z "$DISABLE_ATUIN" ] && [ "$(command -v atuin)" ] && eval "$(atuin init zsh)"
  [ -z "$DISABLE_ZOXIDE" ] && [ "$(command -v zoxide)" ] && eval "$(zoxide init zsh --cmd cd)"
fi


curl_harder() {
  local count=0;
  until curl "$@" -O --retry 999 --retry-max-time 0 -C -
  do
    ((count++))
    echo "Reattempting download...${count}"
    sleep 1
  done
}

. "$HOME/.local/bin/dotfiles-motd"
