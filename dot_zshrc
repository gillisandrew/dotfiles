## .zshrc: interactive shell config
# Runs for interactive shells only.
# Good: prompt/theme, aliases, functions, completions, keybindings.
# Avoid: PATH/toolchain exports (keep those in .zprofile).

[[ -o interactive ]] || return

. "$HOME/.local/bin/dotfiles-env"

autoload -Uz compinit
if [[ -f ~/.zcompdump && $(date +'%j') == $(stat -f '%Sm' -t '%j' ~/.zcompdump 2>/dev/null) ]]; then
  compinit -C  # use cached dump (skips security check + regeneration)
else
  compinit     # full rebuild
fi

if [ "$DOTFILES_ENV" = "macos" ]; then
  [ -S "$HOME/.bitwarden-ssh-agent.sock" ] && export SSH_AUTH_SOCK="$HOME/.bitwarden-ssh-agent.sock"
fi

[ "$(command -v curlie)" ] && alias curl="curlie"
[ "$(command -v bat)" ] && alias cat="bat"

if [ "$DOTFILES_OS" = "macos" ]; then
  _brew_prefix="/opt/homebrew"
elif [ "$DOTFILES_OS" = "linux" ]; then
  _brew_prefix="/home/linuxbrew/.linuxbrew"
fi
if [ -n "$_brew_prefix" ]; then
  [ -f "$_brew_prefix/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ] && source "$_brew_prefix/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
  [ -f "$_brew_prefix/share/zsh-autosuggestions/zsh-autosuggestions.zsh" ] && source "$_brew_prefix/share/zsh-autosuggestions/zsh-autosuggestions.zsh"
fi
unset _brew_prefix

. "$HOME/.local/share/shell/functions.sh"

export CARAPACE_BRIDGES='zsh,fish,bash,inshellisense' # optional
export CARAPACE_MATCH=1
# zstyle ':completion:*' format $'\e[2;37mCompleting %d\e[m'

_shell_cache_dir="$HOME/.cache/shell-init"
[ -d "$_shell_cache_dir" ] || mkdir -p "$_shell_cache_dir"

_cached_init() {
  # Usage: _cached_init <cache-file> <command...>
  local cache="$_shell_cache_dir/$1"; shift
  if [ ! -f "$cache" ]; then
    "$@" > "$cache" 2>/dev/null
  fi
  source "$cache"
}

if [ -z "$CLAUDECODE" ]; then
  [ -z "$DISABLE_CARAPACE" ] && [ "$(command -v carapace)" ] && _cached_init carapace.zsh carapace _carapace zsh
  [ -z "$DISABLE_FZF" ] && [ "$(command -v fzf)" ] && _cached_init fzf.zsh fzf --zsh
  [ -z "$DISABLE_STARSHIP" ] && [ "$(command -v starship)" ] && _cached_init starship.zsh starship init zsh
  [ -z "$DISABLE_ATUIN" ] && [ "$(command -v atuin)" ] && _cached_init atuin.zsh atuin init zsh
  [ -z "$DISABLE_ZOXIDE" ] && [ "$(command -v zoxide)" ] && _cached_init zoxide.zsh zoxide init zsh --cmd cd
fi

unset _shell_cache_dir
unset -f _cached_init


. "$HOME/.local/bin/dotfiles-motd-fast"
