## .bashrc: interactive shell config
# Runs for interactive shells only.
# Good: prompt/theme, aliases, functions, completions, keybindings.
# Avoid: PATH/toolchain exports (keep those in .profile).

case $- in *i*) ;; *) return;; esac

# Source login env if not already loaded (e.g. Codespaces non-login shells)
if [ -z "$DOTFILES_OS" ] && [ -f "$HOME/.profile" ]; then
  . "$HOME/.profile"
fi

. "$HOME/.local/bin/dotfiles-env"

if [ "$DOTFILES_ENV" = "macos" ]; then
  [ -S "$HOME/.bitwarden-ssh-agent.sock" ] && export SSH_AUTH_SOCK="$HOME/.bitwarden-ssh-agent.sock"
fi

# Common aliases
if [ "$DOTFILES_ENV" = "macos" ]; then
  alias espansoconfig="code \"$HOME/.config/espanso\""
fi
[ "$(command -v curlie)" ] && alias curl="curlie"
[ "$(command -v bat)" ] && alias cat="bat"

. "$HOME/.local/share/shell/functions.sh"

export CARAPACE_BRIDGES='zsh,fish,bash,inshellisense' # optional
export CARAPACE_MATCH=1

_shell_cache_dir="$HOME/.cache/shell-init"
[ -d "$_shell_cache_dir" ] || mkdir -p "$_shell_cache_dir"

_cached_init() {
  # Usage: _cached_init <cache-file> <command...>
  local cache="$_shell_cache_dir/$1"; shift
  if [ ! -f "$cache" ]; then
    "$@" > "$cache" 2>/dev/null
  fi
  source "$cache"
}

if [ -z "$CLAUDECODE" ]; then
  [ -z "$DISABLE_CARAPACE" ] && [ "$(command -v carapace)" ] && _cached_init carapace.bash carapace _carapace bash
  [ -z "$DISABLE_STARSHIP" ] && [ "$(command -v starship)" ] && _cached_init starship.bash starship init bash
  [ -z "$DISABLE_ATUIN" ] && [ "$(command -v atuin)" ] && _cached_init atuin.bash atuin init bash
  [ -z "$DISABLE_ZOXIDE" ] && [ "$(command -v zoxide)" ] && _cached_init zoxide.bash zoxide init bash --cmd cd
fi

unset _shell_cache_dir
unset -f _cached_init

. "$HOME/.local/bin/dotfiles-motd-fast"
