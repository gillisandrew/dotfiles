if [ "$DOTFILES_ENV" = "macos" ]; then
  [ -S "$HOME/.bitwarden-ssh-agent.sock" ] && export SSH_AUTH_SOCK="$HOME/.bitwarden-ssh-agent.sock"
fi

[ "$(command -v curlie)" ] && alias curl="curlie"
[ "$(command -v bat)" ] && alias cat="bat"

alias ..='cd ..'
alias ...='cd ../..'
alias la='ls -la'

alias c='claude --model opus'
alias ch='claude --model haiku'
alias cs='claude --model sonnet'
alias ch-commit='claude --model haiku --dangerously-skip-permissions --print '\''stage and commit pending git changes. If a precommit check fails, report back to the user. Do not attempt to fix. Report back with the commit sha and the full commit message.'\'' | glow -'
alias cs-docs-gen='claude --model sonnet --system-prompt '\''Generate API docs in OpenAPI 3.0 format'\'' --allowed-tools '\''Read,Grep,Write'\'''
alias cs-sec-scan='claude --model sonnet --system-prompt '\''Security audit focusing on OWASP Top 10'\'' --allowed-tools '\''Read,Grep'\'''
alias cs-test-gen='claude --model sonnet --system-prompt '\''Generate comprehensive tests with full coverage'\'''

. "$HOME/.local/share/shell/functions.sh"

export CARAPACE_BRIDGES='zsh,fish,bash,inshellisense' # optional
export CARAPACE_MATCH=1

_shell_cache_dir="$HOME/.cache/shell-init"
[ -d "$_shell_cache_dir" ] || mkdir -p "$_shell_cache_dir"

_cached_init() {
  # Usage: _cached_init <cache-file> <command...>
  local cache="$_shell_cache_dir/$1"; shift
  if [ ! -f "$cache" ]; then
    "$@" > "$cache" 2>/dev/null
  fi
  source "$cache"
}

if [ -z "$CLAUDECODE" ]; then
  [ -z "$DISABLE_CARAPACE" ] && [ "$(command -v carapace)" ] && _cached_init carapace.{{ . }} carapace _carapace {{ . }}
{{ if eq . "zsh" }}  [ -z "$DISABLE_FZF" ] && [ "$(command -v fzf)" ] && _cached_init fzf.zsh fzf --zsh
{{ end }}  [ -z "$DISABLE_STARSHIP" ] && [ "$(command -v starship)" ] && _cached_init starship.{{ . }} starship init {{ . }}
  [ -z "$DISABLE_ATUIN" ] && [ "$(command -v atuin)" ] && _cached_init atuin.{{ . }} atuin init {{ . }}
  [ -z "$DISABLE_ZOXIDE" ] && [ "$(command -v zoxide)" ] && _cached_init zoxide.{{ . }} zoxide init {{ . }} --cmd cd
fi

unset _shell_cache_dir
unset -f _cached_init

if command -v brew >/dev/null 2>&1; then
  _dotfiles_command_not_found() {
    local cmd="$1"; shift

    # Skip inside Midnight Commander or non-interactive pipes
    if [[ -n "${MC_SID}" ]] || [[ ! -t 1 ]]; then
      echo "${cmd}: command not found" >&2
      return 127
    fi

    local formula
    formula="$(brew which-formula --skip-update "${cmd}" 2>/dev/null)"

    if [[ -z "${formula}" ]]; then
      echo "${cmd}: command not found" >&2
      return 127
    fi

    echo "brew: \"${cmd}\" is provided by \"${formula}\"" >&2

    local do_install=false
    if command -v gum >/dev/null 2>&1 && [[ -t 0 ]]; then
      gum confirm --default=false "Install ${formula}?" && do_install=true
    else
      printf "Install %s? [y/N] " "${formula}" >&2
      local reply; read -r reply
      [[ "$reply" =~ ^[Yy] ]] && do_install=true
    fi

    if [[ "${do_install}" == true ]]; then
      brew install "${formula}" && command "${cmd}" "$@"
      return $?
    fi

    return 127
  }

{{ if eq . "zsh" }}  command_not_found_handler() { _dotfiles_command_not_found "$@"; }
{{ else }}  command_not_found_handle() { _dotfiles_command_not_found "$@"; }
{{ end }}fi

. "$HOME/.local/bin/dotfiles-motd-fast"
